name: YouTube to Telegram

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest YouTube video ID
        id: youtube
        run: |
          FEED_URL="https://www.youtube.com/feeds/videos.xml?channel_id=UCUOQQgxMLp0MaJL2NJ8Vl2g"
          VIDEO_ID=$(curl -s "$FEED_URL" | grep "<yt:videoId>" | head -n 1 | sed 's/.*<yt:videoId>\(.*\)<\/yt:videoId>.*/\1/')

          if [ -z "$VIDEO_ID" ]; then
            echo "No video ID found. Exiting."
            exit 1
          fi

          echo "video_id=$VIDEO_ID" >> "$GITHUB_OUTPUT"

      - name: Read last posted video
        id: last
        run: |
          if [ -f last_video.txt ]; then
            LAST_VIDEO=$(cat last_video.txt)
          else
            LAST_VIDEO="none"
          fi

          echo "last_video=$LAST_VIDEO" >> "$GITHUB_OUTPUT"

      - name: Send to Telegram groups if new
        if: steps.youtube.outputs.video_id != steps.last.outputs.last_video
        run: |
          VIDEO_ID="${{ steps.youtube.outputs.video_id }}"
          VIDEO_URL="https://youtu.be/$VIDEO_ID"

          MESSAGE="ðŸŽ¥ <b>New YouTube Video Uploaded!</b>\n\n<a href=\"$VIDEO_URL\">Watch Now on YouTube</a>"

          # Send to PUBLIC Group
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.PUBLIC_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.PUBLIC_TOPIC_ID }}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="false" \
            -d text="$MESSAGE"

          # Send to PRIVATE Group
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.PRIVATE_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.PRIVATE_TOPIC_ID }}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="false" \
            -d text="$MESSAGE"

          echo "$VIDEO_ID" > last_video.txt

      - name: Save last video
        if: steps.youtube.outputs.video_id != steps.last.outputs.last_video
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add last_video.txt
          git commit -m "Update last posted video" || echo "No changes"
          git push
