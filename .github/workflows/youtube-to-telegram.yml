name: YouTube to Telegram

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest YouTube video details
        id: youtube
        run: |
          FEED_URL="https://www.youtube.com/feeds/videos.xml?channel_id=UCUOQQgxMLp0MaJL2NJ8Vl2g"
          RESPONSE=$(curl -s "$FEED_URL")

          VIDEO_ID=$(echo "$RESPONSE" | grep "<yt:videoId>" | head -n 1 | sed 's/.*<yt:videoId>\(.*\)<\/yt:videoId>.*/\1/')
          VIDEO_TITLE=$(echo "$RESPONSE" | grep "<title>" | head -n 2 | tail -n 1 | sed 's/.*<title>\(.*\)<\/title>.*/\1/')

          if [ -z "$VIDEO_ID" ]; then
            echo "No video found. Exiting."
            exit 1
          fi

          echo "video_id=$VIDEO_ID" >> "$GITHUB_OUTPUT"
          echo "video_title=$VIDEO_TITLE" >> "$GITHUB_OUTPUT"

      - name: Read last posted video
        id: last
        run: |
          if [ -f last_video.txt ]; then
            LAST_VIDEO=$(cat last_video.txt)
          else
            LAST_VIDEO="none"
          fi
          echo "last_video=$LAST_VIDEO" >> "$GITHUB_OUTPUT"

      - name: Send to Telegram if new
        if: steps.youtube.outputs.video_id != steps.last.outputs.last_video
        run: |
          VIDEO_ID="${{ steps.youtube.outputs.video_id }}"
          VIDEO_TITLE="${{ steps.youtube.outputs.video_title }}"
          VIDEO_URL="https://youtu.be/$VIDEO_ID"
          THUMB_URL="https://img.youtube.com/vi/$VIDEO_ID/maxresdefault.jpg"

          CAPTION=$(printf "<a href=\"%s\">ðŸŽ¥ <b>%s</b></a>\n\nðŸ”¥ <b>New upload from Last Stand Echo!</b>\nDominate the battlefield with pro strategies ðŸ’¥\n\nðŸ‘‡ Tap below to watch ðŸ‘‡" "$VIDEO_URL" "$VIDEO_TITLE")

          KEYBOARD=$(printf '{
            "inline_keyboard": [[
              {
                "text": "â–¶ï¸ Watch Now on YouTube",
                "url": "%s"
              }
            ]]
          }' "$VIDEO_URL")

          # PUBLIC GROUP
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
            -d chat_id="${{ secrets.PUBLIC_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.PUBLIC_TOPIC_ID }}" \
            -d photo="$THUMB_URL" \
            -d parse_mode="HTML" \
            -d caption="$CAPTION" \
            -d reply_markup="$KEYBOARD"

          # PRIVATE GROUP
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
            -d chat_id="${{ secrets.PRIVATE_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.PRIVATE_TOPIC_ID }}" \
            -d photo="$THUMB_URL" \
            -d parse_mode="HTML" \
            -d caption="$CAPTION" \
            -d reply_markup="$KEYBOARD"

          echo "$VIDEO_ID" > last_video.txt

      - name: Save last video
        if: steps.youtube.outputs.video_id != steps.last.outputs.last_video
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add last_video.txt
          git commit -m "Update last posted video" || echo "No changes"
          git push
